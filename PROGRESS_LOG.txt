
--- 2026-02-15 00:03:47 | simple-agent-harness-utz ---
## Last Session: Configuration loading and CLI argument parsing (simple-agent-harness-utz)

### Completed
- Implemented HarnessConfig::load(path) — loads TOML file, returns defaults if file missing, errors on bad parse
- Implemented HarnessConfig::apply_cli_overrides() — CLI flags override config file values when present
- Added CliOverrides struct for extractable CLI override fields
- Added ConfigError enum with Display + Error impls
- Added Clone derive to all config structs
- Wired up config loading in main.rs: load file → apply CLI overrides → use resolved config
- Enhanced --dry-run to print all resolved configuration values
- Added tempfile dev-dependency for test isolation
- 10 unit tests covering: defaults, TOML loading (empty/partial/full), parse errors, CLI overrides (all/none/partial), full precedence chain
- All tests pass, clippy clean, fmt applied

### Current State
- Config loading is fully functional with correct precedence: CLI > file > defaults
- main.rs loads config and applies overrides before any mode checks
- Stub modules still have dead_code warnings (expected — they're scaffolded but not yet used)

### Suggested Next Tasks
- Implement main runner loop (simple-agent-harness-p0y) — depends on this config work, now unblocked
- Implement signal handling (simple-agent-harness-7rx) — also unblocked
- Implement session spawning (simple-agent-harness-d3v) — also unblocked

--- 2026-02-15 01:14:02 | simple-agent-harness-3dl ---
## Last Session: Implement status file with atomic JSON writes (simple-agent-harness-3dl)

### Completed
- Created src/status.rs with:
  - `HarnessState` enum: Starting, PreHooks, SessionRunning, WatchdogKill, Retrying, PostHooks, RateLimitedBackoff, Idle, ShuttingDown (all states from PRD)
  - `StatusData` struct: all JSON fields from PRD (pid, state, iteration, max_iterations, global_iteration, output_file, output_bytes, session_start, last_update, last_completed_iteration, last_committed, consecutive_rate_limits)
  - `StatusFile`: atomic write (write-to-temp + rename) and remove operations
  - `StatusTracker`: mutable state tracker with setter methods, builds StatusData and writes via StatusFile
  - `StatusError` enum with Display/Error impls
  - 7 unit tests covering atomic write, overwrite, remove, all state serialization, tracker lifecycle, error paths, error display
- Integrated StatusTracker into runner.rs:
  - Starting state at loop begin
  - SessionRunning state before each session spawn (with output_file, iteration, session_start)
  - Idle state after productive iterations
  - Retrying state on empty session retry
  - ShuttingDown state on all exit paths (STOP file, signal, prompt error, consecutive errors)
  - Status file removed on clean exit
- Status file written to `{output_dir}/harness.status`
- All 68 tests pass, clippy clean, fmt applied

### Current State
- Status file is fully functional with atomic writes at every state transition
- Pre-existing dead_code warnings remain for unimplemented modules (hooks, metrics) and not-yet-used status variants (PreHooks, PostHooks, WatchdogKill, RateLimitedBackoff)
- Those variants will be used when hooks (8ff) and rate limiting (7d0) are implemented

### Suggested Next Tasks
- Implement structured console logging with tracing (yyb) — P2, unblocked
- Implement pre/post-session hook execution (8ff) — P2, will use PreHooks/PostHooks states
- Implement JSONL event log (t0t) — P2, unblocked

--- 2026-02-15 01:17:31 | simple-agent-harness-fgf ---
## Last Session: Implement --status CLI command (simple-agent-harness-fgf)

### Completed
- Implemented `--status` CLI command that reads `harness.status` JSON and displays formatted output
- Added `Deserialize` derive to `HarnessState` and `StatusData` for JSON read-back
- Added `StatusFile::read()` method to deserialize the status file (returns None if missing)
- Added `StatusError::Deserialize` and `StatusError::Read` variants with Display/Error impls
- Added `display_status()` function with:
  - PID liveness check via `nix::sys::signal::kill(pid, None)` (signal 0)
  - "not running (stale status file)" label when PID is dead
  - Human-readable byte formatting (B/KB/MB)
  - Human-readable uptime from session_start
  - Last completed iteration with commit status
  - Consecutive rate limits display
- Updated main.rs to call `display_status()` instead of placeholder
- Handles missing status file gracefully with "No running harness detected."
- Added 10 new tests: read roundtrip, read missing, read invalid JSON, format_bytes, format_uptime, state display labels, display_status no file, display_status with data, deserialize error display, read error display
- All 78 tests pass, clippy clean, fmt applied

### Current State
- `--status` command is fully functional, matches PRD output format
- Pre-existing dead_code warnings remain for unimplemented modules (hooks, metrics, retry.current_attempt, session.output_file, watchdog.ProcessExited)

### Suggested Next Tasks
- Implement structured console logging with tracing (yyb) — P2, unblocked
- Implement JSONL event log (t0t) — P2, unblocked
- Implement pre/post-session hook execution (8ff) — P2, unblocked

--- 2026-02-15 01:20:12 | simple-agent-harness-yyb ---
## Last Session: Implement structured console logging with tracing (simple-agent-harness-yyb)

### Completed
- Configured tracing_subscriber with EnvFilter for log level control:
  - `--quiet` flag → warn level and above
  - `--verbose` flag → debug level and above
  - Default → info level
  - RUST_LOG env var overrides CLI flags
- Added `env-filter` feature to tracing-subscriber in Cargo.toml
- Replaced println! calls in main startup/finish with tracing::info! macros using structured key=value fields
- Replaced eprintln! calls in signals.rs with tracing::warn! macros (removed duplicate eprintln+tracing pairs)
- Replaced eprintln! in --status error path with tracing::error!
- Kept println! for --dry-run and --status display output (intentional user-facing output, not log messages)
- All 78 tests pass, clippy clean, fmt applied

### Current State
- Structured logging is fully functional with tracing_subscriber
- Log format: `[timestamp] [LEVEL] key=value message` via tracing_subscriber::fmt defaults
- Pre-existing dead_code warnings remain for unimplemented modules (hooks, metrics, retry.current_attempt, session.output_file, watchdog.ProcessExited)

### Suggested Next Tasks
- Implement JSONL event log (t0t) — P2, unblocked
- Implement pre/post-session hook execution (8ff) — P2, unblocked
- Implement prompt prepend_commands (mxg) — P2, unblocked

--- 2026-02-15 01:25:32 | simple-agent-harness-t0t ---
## Last Session: Implement JSONL event log for external tooling (simple-agent-harness-t0t)

### Completed
- Added `OutputConfig` struct with `event_log: Option<PathBuf>` to config.rs
- Replaced placeholder metrics.rs with full `EventLog` implementation:
  - `SessionEvent` struct with serde Serialize, fields: ts, event, iteration, global, output_bytes, exit_code, duration_secs, committed, retries, rate_limited
  - `EventLog` struct with append-only JSONL writing (open+append+writeln per event)
  - `EventLogError` error type with Display + Error impls
  - `SessionEvent::session_complete()` constructor
- Integrated event log into runner.rs:
  - Creates EventLog from config.output.event_log if configured
  - Emits session_complete event on both Proceed and Skip retry decisions
  - Tracks retries_this_session counter for accurate retry counts
- Updated main.rs dry_run output to display output.event_log setting
- Updated harness.toml with commented-out [output] section
- Updated config tests for new OutputConfig field
- Added 2 runner integration tests: event log creation + no-event-log-when-unconfigured
- Added 6 metrics unit tests for serialization, appending, error handling
- All 87 tests pass, clippy clean, fmt applied

### Current State
- Event log is fully functional: configure `[output] event_log = "harness-events.jsonl"` to enable
- The `committed` and `rate_limited` fields are always false for now (will be populated when commit detection and rate limit features are implemented)
- Pre-existing dead_code warnings remain for unimplemented modules (hooks, retry.current_attempt, session.output_file, watchdog.ProcessExited)

### Suggested Next Tasks
- Implement pre/post-session hook execution (8ff) — P2, unblocked
- Implement prompt prepend_commands (mxg) — P2, unblocked
- Implement rate limit detection with exponential backoff (7d0) — P3, will populate rate_limited field
- Implement commit detection in session output (ee7) — P3, will populate committed field

--- 2026-02-15 01:34:28 | simple-agent-harness-8ff ---
## Last Session: Implement pre/post-session hook execution (simple-agent-harness-8ff)

### Completed
- Replaced placeholder hooks.rs with full implementation:
  - `HookRunner` struct with `run_pre_session()` and `run_post_session()` methods
  - `HookEnv` struct for building environment variables available to hooks
  - `HookError` / `HookErrorKind` error types with Display + Error impls
  - Hooks executed via `sh -c` with environment variables injected
  - Pre-session hooks: HARNESS_ITERATION, HARNESS_GLOBAL_ITERATION, HARNESS_PROMPT_FILE
  - Post-session hooks: all pre vars plus HARNESS_OUTPUT_FILE, HARNESS_EXIT_CODE, HARNESS_OUTPUT_BYTES, HARNESS_SESSION_DURATION, HARNESS_COMMITTED
- Integrated hooks into runner.rs:
  - Pre-session hooks run before each session, after output dir setup
  - Pre-session hook failure skips the iteration and counts as consecutive error
  - Post-session hooks run after Proceed and Skip decisions (productive sessions)
  - Post-session hooks do NOT run during Retry (empty session retries)
  - Post-session hook failures are logged but don't stop the loop
  - Status transitions to PreHooks/PostHooks states during hook execution
- Added 12 hooks unit tests (env construction, success/failure, env var passing)
- Added 5 runner integration tests (pre hooks with env, pre hook failure, post hooks with env, post hook failure continues, empty retry skips post hooks)
- All 103 tests pass, clippy clean, fmt applied

### Current State
- Hook system is fully functional per spec
- `committed` field always false (commit detection not yet implemented)
- Pre-existing dead_code warnings remain for unimplemented features

### Suggested Next Tasks
- Implement prompt prepend_commands (mxg) — P2, unblocked
- Implement rate limit detection with exponential backoff (7d0) — P3, will populate rate_limited field
- Implement commit detection in session output (ee7) — P3, will populate committed field

--- 2026-02-15 01:53:18 | simple-agent-harness-mxg ---
## Last Session: Implement prompt prepend_commands (simple-agent-harness-mxg)

### Completed
- Created src/prompt.rs with full prompt assembly logic:
  - `assemble()` function reads prompt file and runs prepend_commands
  - Prompt file path: uses `[prompt] file` if set, otherwise `session.prompt_file` (fallback)
  - Each prepend command runs via `sh -c`, stdout captured
  - Non-empty outputs prepended to prompt, separated by "\n---\n"
  - Empty/whitespace-only command outputs silently skipped
  - Non-zero exit commands still have stdout captured (logged as warning)
  - Spawn failures return `PromptError::CommandFailed`
  - `PromptError` enum with ReadFile and CommandFailed variants, Display + Error impls
- Integrated into runner.rs:
  - Replaced `read_prompt()` with `prompt::assemble()` call
  - Removed the now-unused `read_prompt` helper function
- Added `mod prompt` to main.rs
- 13 unit tests covering:
  - No prepend commands (passthrough)
  - Prompt file override via `[prompt] file`
  - Fallback to session.prompt_file
  - Single and multiple prepend commands
  - Empty command output skipping
  - All commands empty returns raw prompt
  - Non-zero exit still captures output
  - Missing prompt file error
  - Whitespace-only output skipped
  - Multiline command output
  - run_prepend_command success and empty cases
- All 116 tests pass, clippy clean, fmt applied

### Current State
- Prompt assembly system fully functional per PRD spec
- Pre-existing dead_code warnings remain for unimplemented features (metrics, status, watchdog, session)

### Suggested Next Tasks
- Implement rate limit detection with exponential backoff (7d0) — P3
- Implement commit detection in session output (ee7) — P3
- Implement --dry-run mode (5x6) — P3

--- 2026-02-15 01:58:33 | simple-agent-harness-7d0 ---
## Last Session: Implement rate limit detection with exponential backoff (simple-agent-harness-7d0)

### Completed
- Created src/ratelimit.rs with rate limit detection and backoff logic:
  - `detect_rate_limit()` scans output file for rate limit patterns
  - `detect_rate_limit_in_text()` internal helper checks text against compiled regex patterns
  - Patterns: JSON `"error":"rate_limit"`, text `usage limit`, `hit your limit`, `resets.*UTC` (case-insensitive)
  - Uses `regex` crate with `LazyLock` for compiled pattern caching
  - `backoff_delay()` computes exponential backoff: `initial_delay * 2^count`, capped at max_delay
  - Overflow-safe with checked_shl + saturating_mul
- Integrated into runner.rs:
  - Added `ExitReason::RateLimited` variant
  - After session passes retry check (Proceed), scans output for rate limit patterns
  - Rate-limited sessions: don't increment productive counter, apply exponential backoff, update status tracker
  - After max_consecutive_rate_limits, exits loop with RateLimited reason
  - Successful sessions reset consecutive_rate_limits counter to 0
  - Status tracker updated with consecutive_rate_limits on each detection
  - Event log entries now correctly report rate_limited=true/false
- Added `mod ratelimit` to main.rs
- Added `regex = "1"` to Cargo.toml dependencies
- 21 new tests (18 unit + 3 integration):
  - Unit: JSON pattern, text patterns (case-insensitive), file detection, missing file, backoff math, overflow safety
  - Integration: rate-limited sessions not counted productive, resets on success, event log shows rate_limited=true
- All 137 tests pass, clippy clean, fmt applied

### Current State
- Rate limit detection fully functional per PRD spec
- Pre-existing dead_code warnings remain for unimplemented features (metrics, status, watchdog, session)
- Note: bead 0t2 (rate limit false positive fix) should refine detection to only inspect final result event

### Suggested Next Tasks
- Implement commit detection in session output (ee7) — P3
- Implement --dry-run mode (5x6) — P3
- Fix rate limit false positives by only inspecting system events (0t2) — P3

--- 2026-02-15 02:42:03 | simple-agent-harness-0t2 ---
## Last Session: Fix rate limit false positives (simple-agent-harness-0t2)

### Completed
- Rewrote rate limit detection to only inspect the final `type=result` JSONL event
- Previously: `detect_rate_limit()` grepped the entire output file for rate limit patterns,
  causing false positives when the agent read source files mentioning rate limiting
- Now: `detect_rate_limit_in_result_event()` finds the last `"type":"result"` line, checks
  `is_error`/`subtype`, and only scans for rate limit patterns if the session ended in error
- A successful session (`is_error: false`, `subtype: "success"`) is NEVER classified as rate-limited
- Simplified patterns: removed `resets.*UTC` pattern (too broad), consolidated to:
  `rate[_.\s]limit`, `usage limit`, `hit your limit` (all case-insensitive)
- Updated all ratelimit.rs unit tests (21 tests) to use JSONL result event format
- Updated 3 runner.rs integration tests to produce proper JSONL result events via shell scripts
- Added new integration test: `test_successful_session_with_rate_limit_text_not_detected`
  verifying the core false-positive fix works end-to-end
- All 140 tests pass, clippy clean, fmt applied

### Current State
- Rate limit detection is now safe against false positives from tool output content
- Pre-existing dead_code warnings remain for unimplemented features (metrics, status, watchdog, session)

### Suggested Next Tasks
- Implement commit detection in session output (ee7) — P3
- Implement --dry-run mode (5x6) — P3
- Implement --quiet mode for minimal output (r43) — P3

--- 2026-02-15 04:53:28 | simple-agent-harness-ee7 ---
## Last Session: Implement commit detection in session output (simple-agent-harness-ee7)

### Completed
- Created `src/commit.rs` module with commit detection logic
  - `detect_commit()`: scans session output file for commit indicator patterns
  - `compile_patterns()`: compiles user-configurable regex patterns at startup
  - `default_patterns()`: provides 3 defaults — `bd-finish`, `(?i)git commit`, `(?i)\bcommitted\b`
  - 15 unit tests covering pattern matching, file I/O, custom patterns, edge cases
- Added `CommitDetectionConfig` to `config.rs` with configurable `patterns` field
  - Defaults use `commit::default_patterns()` — backward-compatible
  - Configurable via `[commit_detection] patterns = [...]` in harness.toml
- Wired commit detection into `runner.rs`:
  - Patterns compiled once at loop start
  - After each productive session, scans output for commit indicators
  - Sets `committed` field in event log (`SessionEvent`)
  - Sets `last_committed` in status file (`StatusTracker`)
  - Passes `committed` to post-session hooks via `HARNESS_COMMITTED` env var
- Added 3 integration tests in runner.rs:
  - `test_commit_detected_in_event_log` — verifies committed=true in event log
  - `test_no_commit_detected_in_event_log` — verifies committed=false when no match
  - `test_commit_detected_in_post_hook_env` — verifies HARNESS_COMMITTED=true in hooks
- Updated `harness.toml` with `[commit_detection]` section
- Updated `--dry-run` output to show commit_detection.patterns
- All 158 tests pass, clippy clean, fmt applied

### Current State
- Commit detection fully implemented and tested
- Pre-existing dead_code warnings remain for unimplemented features (metrics path, status path, watchdog, session, retry)

### Suggested Next Tasks
- Implement --dry-run mode (5x6) — P3
- Implement --quiet mode for minimal output (r43) — P3
- Implement config validation with helpful error messages (edb) — P3

--- 2026-02-15 13:49:42 | simple-agent-harness-ynf ---
## Last Session: Rename package and binary from simple-agent-harness to blacksmith (simple-agent-harness-ynf)

### Completed
- Renamed Cargo.toml package name from `simple-agent-harness` to `blacksmith`
- Updated CLI struct: command name to `blacksmith`, default config to `blacksmith.toml`
- Updated dry-run output header from `simple-agent-harness` to `blacksmith`
- Updated startup log message from `simple-agent-harness starting` to `blacksmith starting`
- Updated `--status` output to say "No running blacksmith detected"
- Updated status file from `harness.status` to `blacksmith.status` in main.rs and runner.rs
- Updated status.rs doc comments and temp file pattern from `.harness.status.tmp` to `.blacksmith.status.tmp`
- Updated all status.rs test file names to `blacksmith.status`
- Added backwards-compatible config loading: tries `blacksmith.toml` first, falls back to `harness.toml`
- Created `blacksmith.toml` from `harness.toml` with updated header comment
- Kept `harness.toml` for backwards compatibility (users can migrate at their own pace)
- Kept `HARNESS_*` environment variables unchanged (public API for hooks)
- All 158 tests pass, clippy clean, fmt applied

### Current State
- Binary is now `blacksmith` (cargo builds as `blacksmith`)
- Config defaults to `blacksmith.toml` with fallback to `harness.toml`
- Status file is now `blacksmith.status`
- Pre-existing dead_code warnings remain for unimplemented features

### Suggested Next Tasks
- Implement --dry-run mode (5x6) — P3
- Implement --quiet mode for minimal output (r43) — P3
- Implement config validation with helpful error messages (edb) — P3

--- 2026-02-15 13:52:03 | simple-agent-harness-sxy ---
## Last Session: Add SQLite dependency and create database module with improvements table (simple-agent-harness-sxy)

### Completed
- Added `rusqlite` v0.31 with `bundled` feature to Cargo.toml
- Created `src/db.rs` module with:
  - `open_or_create(path)` function that opens/creates SQLite database at given path
  - Improvements table schema per PRD: id, ref, created, resolved, category, status, title, body, context, tags, meta
  - Indexes on status and category columns
  - WAL journal mode enabled for better concurrent read performance
  - `next_ref(conn)` function for auto-increment ref assignment (R1, R2, ...)
- Added `mod db` to `src/main.rs`
- 13 comprehensive tests covering: creation, idempotency, insert/query, defaults, timestamps, uniqueness, ref generation, all columns, index usage, persistence
- All 171 tests pass (158 existing + 13 new), clippy clean, fmt applied

### Current State
- Database module is ready but not yet wired into the runner loop
- Pre-existing dead_code warnings remain for unimplemented features (metrics.path, retry.current_attempt, etc.)
- The db::open_or_create and db::next_ref are pub but currently show dead_code warnings since nothing calls them yet

### Suggested Next Tasks
- Create events and observations tables in database module (cl6) — P1, now unblocked
- Implement improve add and improve list CLI subcommands (evl) — P1, now unblocked

--- 2026-02-15 13:55:59 | simple-agent-harness-evl ---
## Last Session: Implement improve add and improve list CLI subcommands (simple-agent-harness-evl)

### Completed
- Added clap subcommand structure to `src/main.rs`: `blacksmith improve add` and `blacksmith improve list`
- `improve add` takes positional title, required `--category`, optional `--body`, `--context`, `--tags`
- Auto-assigns next ref (R1, R2, ...) on creation using existing `db::next_ref`
- `improve list` supports `--status` and `--category` filters, displays in table format
- Created `src/improve.rs` with `handle_add` and `handle_list` command handlers
- Added `db::insert_improvement` and `db::list_improvements` query functions to `src/db.rs`
- Added `db::Improvement` struct for query results
- 7 new tests (in improve.rs): add, add with all fields, multiple ref increment, list empty, filter by status, filter by category, combined filters
- All 178 tests pass, clippy clean (only pre-existing dead_code warnings), fmt applied
- Smoke tested CLI: add, list, filtered list all work correctly

### Current State
- `improve add` and `improve list` are fully functional
- Database path defaults to `./blacksmith.db`, overridable with `--output-dir`
- The `--output-dir` flag is global (works with subcommands), other run-mode flags are not
- Pre-existing dead_code warnings remain for unimplemented features

### Suggested Next Tasks
- Create events and observations tables in database module (cl6) — P1, ready
- Implement improve show/update/promote/dismiss/search commands (v25) — P2, now unblocked
- Implement brief command with improvement context output (11h) — P1, now unblocked

--- 2026-02-15 13:58:02 | simple-agent-harness-11h ---
## Last Session: Implement brief command with improvement context output (simple-agent-harness-11h)

### Completed
- Created `src/brief.rs` with `handle_brief` function
- `blacksmith brief` generates markdown snippet for prompt injection
- Queries open improvements from DB, formats as: `## OPEN IMPROVEMENTS (N of M)` followed by `Rxx [category] title` lines
- Returns no output if DB file doesn't exist or has no improvements
- Added `db::count_improvements` helper to `src/db.rs`
- Wired `Brief` subcommand in `src/main.rs` (top-level, not under metrics)
- 5 new tests: no DB file, empty DB, shows open, excludes non-open, format matches PRD
- All 183 tests pass, clippy clean (only pre-existing dead_code warnings), fmt applied

### Current State
- `blacksmith brief` is fully functional
- Uses same `--output-dir` flag to locate DB as `improve` commands
- Pre-existing dead_code warnings remain for unimplemented features

### Suggested Next Tasks
- Create events and observations tables (cl6) — P1, ready
- Integrate brief injection into session loop pre-session step (2pg) — P1, now unblocked by this bead
- Add quantitative metrics summary to brief command output (pcb) — P2, now unblocked by this bead

--- 2026-02-15 14:00:59 | simple-agent-harness-2pg ---
## Last Session: Integrate brief injection into session loop pre-session step (simple-agent-harness-2pg)

### Completed
- Added `generate_brief(db_path) -> Result<String, String>` to `src/brief.rs` returning brief text as a string
- Refactored `handle_brief` to use `generate_brief` internally (no behavior change for CLI)
- Modified `prompt::assemble` to accept `output_dir` parameter and auto-inject brief
- Assembly sequence: prepend_commands output → brief from blacksmith.db → prompt file content
- Brief is silently skipped when no DB exists (first run) or DB has no improvements
- Brief generation errors are logged as warnings and skipped (non-fatal)
- Updated call site in `runner.rs` to pass `config.session.output_dir`
- Updated all 12 existing prompt tests to pass output_dir
- Added 4 new tests: no DB skips brief, empty DB skips brief, brief after prepend, brief without prepend
- All 187 tests pass, clippy clean (only pre-existing dead_code warnings), fmt applied

### Current State
- Brief injection is fully integrated into the session loop prompt assembly
- The brief appears between prepend_commands output and the prompt file content, separated by `\n---\n`
- Pre-existing dead_code warnings remain for unimplemented features

### Suggested Next Tasks
- Create events and observations tables (cl6) — P1, ready
- Add quantitative metrics summary to brief command output (pcb) — P2, now unblocked
- Implement improve show/update/promote/dismiss/search commands (v25) — P2, ready

--- 2026-02-15 14:03:24 | simple-agent-harness-cl6 ---
## Last Session: Create events and observations tables in database module (simple-agent-harness-cl6)

### Completed
- Added `events` table to `open_or_create` with schema: id, ts, session, kind, value, tags
- Added 3 indexes on events: idx_events_session, idx_events_kind, idx_events_ts
- Added `observations` table with schema: session (PK), ts, duration, outcome, data (JSON)
- Added `Event` struct and insert/query functions:
  - `insert_event(conn, session, kind, value, tags)` — insert with auto-timestamp
  - `insert_event_with_ts(conn, ts, session, kind, value, tags)` — insert with explicit timestamp
  - `events_by_session(conn, session)` — query all events for a session
  - `events_by_kind(conn, kind)` — query all events of a given kind
- Added `Observation` struct and insert/query functions:
  - `upsert_observation(conn, session, ts, duration, outcome, data)` — insert or replace
  - `get_observation(conn, session)` — get single observation
  - `recent_observations(conn, limit)` — get N most recent, descending
- Added 20 new tests covering all new functionality (34 db tests total)
- All 208 tests pass, clippy clean (only pre-existing dead_code warnings), fmt applied

### Current State
- Events and observations tables are fully functional in src/db.rs
- Tables are created idempotently alongside the improvements table
- Dead_code warnings for new functions are expected — downstream tasks will consume them

### Suggested Next Tasks
- Implement built-in JSONL metric extraction for turns, cost, and duration (8j5) — P1, now unblocked
- Implement metrics log and metrics status CLI commands (pr9) — P1, now unblocked
- Implement improve show/update/promote/dismiss/search commands (v25) — P2, ready

--- 2026-02-15 14:07:06 | simple-agent-harness-8j5 ---
## Last Session: Implement built-in JSONL metric extraction (simple-agent-harness-8j5)

### Completed
- Created `src/ingest.rs` with JSONL metric extraction and database ingestion
- `extract_metrics(path)` — parses a Claude JSONL session output file and extracts:
  - turns.total (count of assistant events)
  - turns.narration_only (assistant events with text but no tool_use)
  - turns.parallel (assistant events with 2+ tool_use blocks)
  - turns.tool_calls (total tool_use blocks across all assistant events)
  - cost.input_tokens / cost.output_tokens / cost.cache_read_tokens / cost.cache_creation_tokens (aggregated from modelUsage across all models)
  - cost.estimate_usd (from result.total_cost_usd)
  - session.output_bytes (file size)
  - session.duration_ms (from result.duration_ms)
  - session.exit_code (passed in by caller from SessionResult)
- `ingest_session(conn, session, jsonl_path, exit_code)` — full pipeline:
  - Extracts metrics from JSONL file
  - Writes 11-12 individual events to the events table (one per metric kind)
  - Builds and upserts a JSON observation summarizing all metrics
- `IngestError` enum wrapping IO and DB errors
- 17 new tests covering all extraction logic, ingestion, edge cases, and a realistic multi-event JSONL file
- All 225 tests pass, clippy clean (only pre-existing dead_code warnings), fmt applied

### Current State
- `src/ingest.rs` is complete and ready to be consumed by downstream tasks
- Dead_code warnings for new functions are expected — the integration task (k53) will call ingest_session from the runner loop

### Suggested Next Tasks
- Integrate automatic post-session JSONL ingestion into loop (k53) — P1, now unblocked
- Implement metrics log and metrics status CLI commands (pr9) — P1, now unblocked
- Implement improve show/update/promote/dismiss/search commands (v25) — P2, ready

--- 2026-02-15 14:10:12 | simple-agent-harness-k53 ---
## Last Session: Integrate automatic post-session JSONL ingestion into loop (simple-agent-harness-k53)

### Completed
- Wired `ingest::ingest_session()` into `runner.rs` main loop
- Opens `blacksmith.db` once at loop startup via `db::open_or_create()`
- After each productive session (RetryDecision::Proceed), calls `ingest_session(conn, global_iteration, &output_path, exit_code)` to extract metrics from the JSONL output and write events + observation to the DB
- Also ingests metrics for skipped sessions (RetryDecision::Skip) — they still produce output worth tracking
- All ingestion is non-fatal: DB open failure disables ingestion with a warning, individual ingestion failures are logged as warnings but don't stop the loop
- Added 2 new tests:
  - `test_run_ingests_jsonl_metrics_to_db`: verifies metrics are extracted from JSONL and written to blacksmith.db
  - `test_run_ingestion_does_not_block_on_failure`: verifies loop continues when DB can't be opened
- All 227 tests pass, clippy clean (only pre-existing dead_code warnings), fmt applied

### Current State
- Runner loop now automatically ingests session metrics after each session
- `ingest.rs` functions are no longer dead code (called from runner.rs)
- The `db.rs` query functions (events_by_session, events_by_kind, get_observation, etc.) still show dead_code warnings — they'll be consumed by the metrics CLI commands (pr9)

### Suggested Next Tasks
- Implement metrics log and metrics status CLI commands (pr9) — P1, ready
- Implement improve show/update/promote/dismiss/search commands (v25) — P2, ready
- Implement configurable extraction rules from TOML config (i9s) — P2, ready

--- 2026-02-15 14:12:38 | simple-agent-harness-pr9 ---
## Last Session: Implement metrics log and metrics status CLI commands (simple-agent-harness-pr9)

### Completed
- Created `src/metrics_cmd.rs` with two command handlers:
  - `handle_log(db_path, file)`: Ingests a JSONL session file into the metrics DB, auto-assigning session number as max(session)+1
  - `handle_status(db_path, last)`: Displays a dashboard table of recent sessions with turns, cost, duration, narration%, parallel% plus summary averages and totals
- Wired `Metrics` subcommand into `main.rs` with `MetricsAction` enum (Log + Status variants)
- Added `--last N` flag to `metrics status` (default: 10)
- 8 new tests in metrics_cmd module covering all code paths
- All 237 tests pass, clippy clean, fmt applied

### Current State
- CLI now supports `blacksmith metrics log <file>` and `blacksmith metrics status [--last N]`
- The `metrics log` command calls the same `ingest::ingest_session` used by the runner loop
- The `metrics status` command queries `db::recent_observations` and displays a formatted table
- Some db.rs dead_code warnings remain for functions that will be consumed by future features (events_by_session, events_by_kind, get_observation, etc.)

### Suggested Next Tasks
- Implement improve show/update/promote/dismiss/search commands (v25) — P2, ready
- Implement configurable extraction rules from TOML config (i9s) — P2, ready
- Implement configurable target thresholds and metrics targets command (obm) — P2, ready
- Add quantitative metrics summary to brief command output (pcb) — P2, now unblocked by pr9

--- 2026-02-15 14:15:41 | simple-agent-harness-v25 ---
## Last Session: Implement improve show/update/promote/dismiss/search commands (simple-agent-harness-v25)

### Completed
- Added `db::get_improvement(conn, ref_id)` — fetch single improvement by ref
- Added `db::get_improvement_meta(conn, ref_id)` — fetch meta JSON field by ref
- Added `db::update_improvement(conn, ref_id, status, body, context, meta)` — dynamic field updates with auto-resolved timestamp on promote/dismiss
- Added `db::search_improvements(conn, query)` — case-insensitive LIKE search across title, body, context
- Added 5 new CLI handlers in `improve.rs`:
  - `handle_show(db_path, ref_id)` — display all fields for a single improvement
  - `handle_update(db_path, ref_id, status, body, context)` — modify fields by ref
  - `handle_promote(db_path, ref_id)` — shorthand for status=promoted with resolved timestamp
  - `handle_dismiss(db_path, ref_id, reason)` — shorthand for status=dismissed with reason in meta JSON
  - `handle_search(db_path, query)` — full-text search with tabular output
- Wired 5 new `ImproveAction` variants (Show, Update, Promote, Dismiss, Search) in main.rs
- 33 new tests across db.rs and improve.rs (270 total tests pass)
- Clippy clean, fmt applied

### Current State
- CLI now supports all 7 improve subcommands: add, list, show, update, promote, dismiss, search
- Pre-existing dead_code warnings remain for functions consumed by future features (events, observations, etc.)

### Suggested Next Tasks
- Add quantitative metrics summary to brief command output (pcb) — P2, ready
- Implement configurable extraction rules from TOML config (i9s) — P2, ready
- Implement configurable target thresholds and metrics targets command (obm) — P2, ready

--- 2026-02-15 14:18:39 | simple-agent-harness-pcb ---
## Last Session: Add quantitative metrics summary to brief command output (simple-agent-harness-pcb)

### Completed
- Extended `generate_brief()` in `brief.rs` to include a `## PERFORMANCE FEEDBACK (auto-generated)` section
- Queries the most recent observation from the database via `db::recent_observations(conn, 1)`
- Parses the observation's JSON data field and formats metrics: turns, narration %, parallel %, cost, duration
- Performance feedback section appears before the OPEN IMPROVEMENTS section
- Output matches PRD format: "Last session #N:" followed by metric lines
- Brief still works correctly when only improvements exist (no observations) or only observations (no improvements)
- Added 8 new tests for performance feedback (277 total tests pass)
- Clippy clean, fmt applied

### Current State
- Brief command now outputs both performance feedback and improvements
- Target comparison (OK/MISS) not yet implemented — depends on configurable targets (obm bead)
- Pre-existing dead_code warnings remain for functions consumed by future features

### Suggested Next Tasks
- Implement configurable extraction rules from TOML config (i9s) — P2, ready
- Implement configurable target thresholds and metrics targets command (obm) — P2, ready
- Add target miss warnings and streak detection to brief output (h97) — P2, blocked by obm

--- 2026-02-15 14:24:50 | simple-agent-harness-i9s ---
## Last Session: Implement configurable extraction rules from TOML config (simple-agent-harness-i9s)

### Completed
- Added `MetricsConfig` → `MetricsExtractConfig` → `Vec<ExtractionRule>` to `config.rs`
- Each rule supports: kind, pattern (regex), anti_pattern, source (tool_commands/text/raw), transform (last_segment/int/trim), first_match, count, emit
- Added `CompiledRule` struct and `ExtractionRule::compile()` method for regex compilation
- Updated `ingest.rs` to collect session text (raw lines, text blocks, tool commands) during parsing
- Added `ingest_session_with_rules()` that applies configurable rules alongside built-in metrics
- Rule results written as events and included in observation data JSON
- Updated `runner.rs` to compile extraction rules at startup and pass them to ingestion
- Added 24 new tests (301 total pass): config parsing, rule compilation, all rule modes (count, emit, first_match, anti_pattern, source types, transforms), end-to-end ingestion with rules
- Clippy clean, fmt applied

### Current State
- Adding a new metric = 3-4 lines of TOML in `[metrics.extract.rules]`
- `ingest_session()` still works without rules (backward compatible)
- Pre-existing dead_code warnings remain for functions consumed by future features

### Suggested Next Tasks
- Implement configurable target thresholds and metrics targets command (obm) — P2, ready
- Add target miss warnings and streak detection to brief output (h97) — P2, blocked by obm
- Implement --dry-run mode (5x6) — P3, ready

--- 2026-02-15 14:28:40 | simple-agent-harness-obm ---
## Last Session: Implement configurable target thresholds and metrics targets command (simple-agent-harness-obm)

### Completed
- Added `MetricsTargetsConfig` and `TargetRule` structs to `config.rs`
  - Each rule: kind, compare (pct_of/pct_sessions/avg), relative_to, threshold, direction (above/below), label, unit
  - Nested under `[metrics.targets.rules]` in blacksmith.toml
- Added `Targets` subcommand to `MetricsAction` enum in `main.rs`
  - Accepts `--last N` flag (default 10) for window size
  - Loads config to pass target rules to handler
- Implemented `handle_targets` in `metrics_cmd.rs`
  - Loads recent observations, parses JSON data
  - Evaluates each rule: avg (average over sessions), pct_of (ratio of two metrics), pct_sessions (% sessions with event present)
  - Direction-aware comparison: "above" = good when >= threshold, "below" = good when <= threshold
  - Formatted output with unit-aware display ($, %, raw) and OK/MISS status
  - Summary line: "All N target(s) met" or "X/N target(s) met, Y missed"
- Added 17 new tests (318 total pass): evaluate_target for avg/pct_of/pct_sessions/no_data/unknown_mode, format_target_line with $/%/miss, full handle_targets with DB for pass/fail/empty/mixed cases, TOML config parsing
- Clippy clean, fmt applied

### Current State
- `blacksmith metrics targets` command fully functional
- Target rules are purely config-driven — add TOML, no code changes needed
- Pre-existing dead_code warnings remain for functions consumed by future features
- The `evaluate_target` and `format_target_line` functions are internal to metrics_cmd.rs

### Suggested Next Tasks
- Add target miss warnings and streak detection to brief output (h97) — P2, was blocked by obm (now unblocked)
- Implement --dry-run mode (5x6) — P3, ready
- Implement --quiet mode for minimal output (r43) — P3, ready

--- 2026-02-15 14:34:08 | simple-agent-harness-h97 ---
## Last Session: Add target miss warnings and streak detection to brief output (simple-agent-harness-h97)

### Completed
- Extended `brief.rs` to auto-generate TARGET WARNINGS section when targets are missed
  - `generate_brief` and `handle_brief` now accept optional `MetricsTargetsConfig`
  - Evaluates each target rule against the most recent observation (per-observation, not aggregate)
  - For each miss, counts consecutive miss streak working backwards through history
  - If streak >= `streak_threshold`, escalates from WARNING to ALERT with streak count
  - Supports "avg" and "pct_of" compare modes (pct_sessions skipped for per-observation evaluation)
  - Format: `WARNING: Label value (target: <threshold)` or `ALERT: ... — missed N consecutive sessions`
- Added `streak_threshold` config field to `MetricsTargetsConfig` in `config.rs`
  - Default: 3, configurable via `[metrics.targets] streak_threshold = N`
  - Manual Default impl ensures default value is 3 (not 0 from derive Default)
- Updated callers in `main.rs` (loads config for Brief command) and `prompt.rs` (passes None)
- Added 22 new tests (340 total pass): single miss, no miss, streak escalation, streak broken by pass,
  pct_of miss, above direction, multiple rules mixed, position ordering, no rules, None config,
  evaluate_single_observation (pass/miss/pct_of/pct_sessions/missing data), format helpers,
  streak exactly at threshold, configurable threshold, config default/TOML parsing
- Clippy clean, fmt applied

### Current State
- `blacksmith brief` output now has 3 sections: PERFORMANCE FEEDBACK → TARGET WARNINGS → OPEN IMPROVEMENTS
- Target warnings only appear when targets are configured and at least one is missed
- Pre-existing dead_code warnings remain for functions consumed by future features

### Suggested Next Tasks
- Implement --dry-run mode (5x6) — P3, ready
- Implement --quiet mode for minimal output (r43) — P3, ready
- Implement config validation with helpful error messages (edb) — P3, ready

--- 2026-02-15 14:35:52 | simple-agent-harness-5x6 ---
## Last Session: Implement --dry-run mode (simple-agent-harness-5x6)

### Completed
- Enhanced `--dry-run` mode in `main.rs` to print ALL resolved config settings:
  - Added `prompt.file` and `prompt.prepend_commands` (were missing)
  - Added `metrics.extract.rules` with per-rule detail (kind, pattern, source, count, first_match)
  - Added `metrics.targets.rules` with per-rule detail (kind, compare, threshold, direction, label)
  - Added `metrics.targets.streak_threshold`
- Added config validation: extraction rule regexes are compiled during dry-run
  - Invalid regex patterns cause exit(1) with clear error message
  - Validation runs before printing config, so invalid configs fail fast
- All 340 tests pass, clippy clean, fmt applied

### Current State
- `blacksmith --dry-run` now prints complete resolved config and exits 0 on valid config
- Invalid extraction rule regexes cause exit 1 with descriptive error
- Pre-existing dead_code warnings remain for functions consumed by future features

### Suggested Next Tasks
- Implement --quiet mode for minimal output (r43) — P3, ready
- Implement config validation with helpful error messages (edb) — P3, ready
- Implement metrics migrate command for V1 data import (j1w) — P3, ready

--- 2026-02-15 14:38:48 | simple-agent-harness-r43 ---
## Last Session: Implement --quiet mode (simple-agent-harness-r43)

### Completed
- Changed `--quiet` flag to filter at `error` level (was `warn`), matching PRD spec: "--quiet = error only"
- Added final summary line in quiet mode via `println!` that bypasses tracing filters
  - Format: `blacksmith: {productive}/{max} productive, global={global}, exit={reason}`
- Passed `quiet` bool through `runner::run()` signature (3rd parameter)
- Updated all 22 test call sites to pass `quiet: false`
- Added `test_quiet_mode_completes_successfully` test
- All 341 tests pass, clippy clean (pre-existing dead_code warnings only), fmt applied

### Current State
- `--quiet` suppresses all info/warn/debug tracing, only shows errors + one final summary line
- `--verbose` shows debug-level messages (unchanged)
- Default shows info+ messages (unchanged)
- Pre-existing dead_code warnings remain for functions consumed by future features

### Suggested Next Tasks
- Implement config validation with helpful error messages (edb) — P3, ready
- Implement metrics migrate command for V1 data import (j1w) — P3, ready
- Implement metrics rebuild command (9cm) — P3, ready

--- 2026-02-15 14:41:52 | simple-agent-harness-edb ---
## Last Session: Implement config validation with helpful error messages (simple-agent-harness-edb)

### Completed
- Added `HarnessConfig::validate()` method that checks all config fields and returns actionable error messages
- Validates: prompt_file exists, output_dir exists/creatable, agent.command in PATH, timeout values > 0, max_iterations > 0, initial_delay <= max_delay, commit_detection patterns compile, extraction rules compile, target rules have valid compare/direction values, pct_of requires relative_to
- Added `command_in_path()` helper that searches PATH directories for the agent binary
- Integrated validation call in main.rs after config load + CLI overrides, before dry_run or main loop
- Removed redundant per-field extraction rule validation from dry_run path (now handled by validate())
- Added 17 new tests covering all validation paths
- All 358 tests pass, clippy clean (pre-existing dead_code warnings only), fmt applied

### Current State
- Config validation runs on every startup, producing clear error messages like:
  `session.prompt_file: file 'missing.md' does not exist`
  `agent.command: binary 'nonexistent' not found in PATH`
  `backoff.initial_delay_secs (1000) must not exceed backoff.max_delay_secs (100)`
- Validation errors are collected (not fail-fast), so users see all issues at once

### Suggested Next Tasks
- Implement metrics migrate command for V1 data import (j1w) — P3, ready
- Implement metrics rebuild command (9cm) — P3, ready
- Implement metrics export, query, and events dump commands (odo) — P3, ready

--- 2026-02-15 14:45:42 | simple-agent-harness-j1w ---
## Last Session: Implement metrics migrate command for V1 data import (simple-agent-harness-j1w)

### Completed
- Added `blacksmith metrics migrate --from <path>` CLI subcommand
- Imports V1 self-improvement.db sessions table into V2 events + observations
- Maps V1 columns to V2 event kinds: assistant_turns->turns.total, narration_turns->turns.narration_only, parallel_turns->turns.parallel, num_tool_calls->turns.tool_calls, input/output/cache tokens, cost_usd->cost.estimate_usd, duration_secs->session.duration_ms (*1000), output_bytes, exit_code
- Imports V1 improvements table, mapping severity->category (critical/high->reliability, medium/normal->workflow, low/minor->code-quality, cost->cost, performance->performance)
- Handles partial V1 schemas gracefully (missing columns default to 0)
- Opens V1 database read-only for safety
- Added 9 new tests covering: not-found, empty V1, full session migration, partial columns, severity mapping, category passthrough, both tables, severity-to-category unit test, no exit_code column
- All 367 tests pass, clippy clean, fmt applied

### Current State
- `metrics migrate` command is fully functional and tested
- V1->V2 migration path is complete for sessions and improvements data

### Suggested Next Tasks
- Implement metrics rebuild command (9cm) — P3, ready
- Implement metrics export, query, and events dump commands (odo) — P3, ready

--- 2026-02-15 14:48:30 | simple-agent-harness-9cm ---
## Last Session: Implement metrics rebuild command (simple-agent-harness-9cm)

### Completed
- Added `blacksmith metrics rebuild` CLI subcommand
- Implemented `db::rebuild_observations()` — deletes all observations, then regenerates from events table
- For each distinct session in events, aggregates (kind, value) pairs into a JSON observation object
- Handles numeric (int/float), boolean, and string event values with proper JSON typing
- Extracts `session.duration_ms` from events to populate observation duration_secs
- Added `handle_rebuild` in metrics_cmd.rs with no-db and empty-db handling
- Added `Rebuild` variant to MetricsAction enum, wired in main.rs match
- Added 9 new tests: 5 in db.rs (empty events, from events, clears old, boolean values, no duration) and 4 in metrics_cmd.rs (no db, empty db, regenerates, replaces stale)
- All 376 tests pass, clippy clean (pre-existing warnings only), fmt applied

### Current State
- `metrics rebuild` command is fully functional and tested
- Drops and recreates observations from events, as specified in PRD

### Suggested Next Tasks
- Implement metrics export, query, and events dump commands (odo) — P3, ready

--- 2026-02-15 14:51:48 | simple-agent-harness-odo ---
## Last Session: Implement metrics export, query, and events dump commands (simple-agent-harness-odo)

### Completed
- Added `blacksmith metrics export [--format csv|json]` CLI subcommand
  - JSON format outputs pretty-printed array of observation objects with session, ts, duration, outcome, and nested data
  - CSV format dynamically discovers all data keys, outputs header + rows with flattened columns
  - Error on unknown format
- Added `blacksmith metrics query <kind> [--last N] [--aggregate avg|trend]` CLI subcommand
  - Default list mode: shows session, timestamp, value for each matching event
  - `--aggregate avg`: computes mean of numeric values
  - `--aggregate trend`: shows values with direction indicator (UP/DOWN/STABLE)
  - `--last N`: limits to N most recent sessions
- Added `blacksmith metrics events [--session N]` CLI subcommand
  - Dumps all raw events with ID, session, timestamp, kind, value, tags
  - `--session N` filters to a single session
- Added 3 new db functions: `all_observations()`, `all_events()`, `events_by_kind_last()`
- Added Export/Query/Events variants to MetricsAction enum, wired in main.rs match
- Added 17 new tests covering all three commands (edge cases: no db, empty db, various formats/modes, error cases)
- All 393 tests pass, clippy clean (pre-existing warnings only), fmt applied

### Current State
- All metrics CLI commands from PRD are now implemented: log, status, targets, migrate, rebuild, export, query, events
- The metrics subsystem is feature-complete per SPEC-v2-metrics.md

### Suggested Next Tasks
- Check `bd ready` for the next available task

--- 2026-02-15 14:57:52 | prd-decomposition ---
## Last Session: PRD-to-beads decomposition of SPEC-v3-agents.md

### Completed
- Decomposed SPEC-v3-agents.md (Milestones 5-9) into 37 beads with full dependency graph
- Milestone 5 (Data Directory & Lifecycle): 6 beads (ib1, 1u6, x1a, 503, wck, jkn)
- Milestone 6 (Agent Adapters): 6 beads (wi2, e2l, 6hk, 9jw, ee2, zb5)
- Milestone 7 (Prompt Delivery & Additional Adapters): 6 beads (tzx, hxq, ec1, y74, 2su, hhv)
- Milestone 8 (Multi-Agent Coordinator & Worktrees): 9 beads (zl7, mjx, 1jv, f9m, 1ky, d2q, wdo, 3mu, dgh)
- Milestone 9 (Integration Loop, Reconciliation & Time Estimation): 10 beads (3pa, v6v, m5l, yg5, 3su, 7ed, dfe, ml7, 506, c37)
- All dependencies wired: 30 blocked, 7 ready to work

### Current State
- 37 open beads, 7 ready (no blockers):
  1. [P1] ib1: Add storage config and .blacksmith/ directory initialization
  2. [P1] wi2: Define AgentAdapter trait and extract Claude adapter
  3. [P1] zl7: Add coordinator SQLite tables for multi-agent state
  4. [P1] mjx: Implement affected set parsing and glob overlap detection
  5. [P1] v6v: Implement task_manifest.toml parsing and manifest application
  6. [P2] tzx: Implement prompt_via config with arg/stdin/file delivery modes
  7. [P2] hxq: Add agent.coding and agent.integration config sections

### Suggested Next Tasks
- Start with ib1 (storage config) — it unblocks 4 downstream beads (1u6, x1a, jkn, 1jv)
- wi2 (AgentAdapter trait) can be done in parallel — it unblocks 7 downstream beads
- zl7 (coordinator tables) can also start in parallel — it unblocks f9m, dgh

--- 2026-02-15 15:01:15 | simple-agent-harness-ib1 ---
## Last Session: Add storage config and .blacksmith/ directory initialization (ib1)

### Completed
- Added `StorageConfig` struct with `data_dir` field (default `.blacksmith/`) to `config.rs`
- Created `src/data_dir.rs` with `DataDir` struct managing directory layout:
  - Accessors: root, db, status, counter, sessions_dir, worktrees_dir, session_file
  - `init()` creates full directory structure (root, sessions/, worktrees/)
  - `ensure_initialized()` creates dirs + appends to .gitignore if present
- Added `blacksmith init` CLI subcommand
- Auto-init on every `blacksmith run` (before dry_run/status checks)
- Added `storage.data_dir` to dry-run output
- 9 tests in data_dir.rs, 2 new tests in config.rs (402 total, all passing)

### Current State
- `storage.data_dir` config field is loaded from TOML `[storage]` section
- `DataDir` struct provides path accessors that downstream beads will use
- Downstream beads (1u6, x1a, jkn, 1jv) are now unblocked

### Suggested Next Tasks
- **1u6**: Migrate file path construction to use storage.data_dir (session output, counter, db, status paths)
- **wi2**: Define AgentAdapter trait and extract Claude adapter (independent, high unblock value)
- **zl7**: Add coordinator SQLite tables (independent)
